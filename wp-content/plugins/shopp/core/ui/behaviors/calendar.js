/*
 * calendar.js - Modal calendar date selector
 * Copyright ?? 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery.fn.PopupCalendar=function(A){var d=jqnc(),F=this,j=d(this),o={month:(new Date().getMonth()+1),year:new Date().getFullYear(),selection:false,m_input:false,d_input:false,y_input:false,input:false,startWeek:0,title:"my",scheduling:true,scheduleAfter:false,disabled:"disabled",scopeMonth:"month",active:"active",selected:"selected",hover:"hover",autoinit:false},A=d.extend(o,A),z=new Array(new Array(0,31,28,31,30,31,30,31,31,30,31,30,31),new Array(0,31,29,31,30,31,30,31,31,30,31,30,31)),n=new Array("",$cal.jan,$cal.feb,$cal.mar,$cal.apr,$cal.may,$cal.jun,$cal.jul,$cal.aug,$cal.sep,$cal.oct,$cal.nov,$cal.dec),v=new Array($cal.sun,$cal.mon,$cal.tue,$cal.wed,$cal.thu,$cal.fri,$cal.sat),r=639787,y=11,E=42,x=4,e=6,k=new Array(30,31,1,2,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1),B=new Date(),t=new Array(),g=new Array(),C=A.month,q=A.year,s=A.m_input,a=A.d_input,f=A.y_input,p=(s)?s:A.input,b=(s)?s.add(a).add(f):p,u=A.startWeek,i=A.title,m=A.autoinit,c=A.disabled,l=A.scopeMonth,h=A.active,w=A.selected,D=A.hover;B=new Date(B.getFullYear(),B.getMonth(),B.getDate());F.scope=l;F.scheduling=A.scheduling;F.selection=(!A.selection)?B:A.selection;F.ui=false;j.mouseenter(function(){F.ui=true}).mouseleave(function(){F.ui=false});F.change(function(){if(p!==false){p.val((F.selection.getMonth()+1)+"/"+F.selection.getDate()+"/"+F.selection.getFullYear())}if(s!==false){s.val(F.selection.getMonth()+1)}if(a!==false){a.val(F.selection.getDate())}if(f!==false){f.val(F.selection.getFullYear())}if(F.focused){F.focused.select()}return this});F.bind("updated",function(){var G=false;if(s!==false&&!(s.val()==""||a.val()==""||f.val()=="")){F.select(new Date(f.val(),s.val()-1,a.val()))}else{if(p!==false){G=p.val().match(/^(\d{1,2}).{1}(\d{1,2}).{1}(\d{4})/);if(G){F.select(new Date(G[3],(G[1]-1),G[2]))}}}});F.select=function(G){if(G){if(G instanceof Date){F.selection=G}else{F.selection=new Date(G)}}F.change().render(F.selection.getMonth()+1,F.selection.getFullYear()).autoselect()};F.render=function(Q,R){j.empty();var L,H,V,S,P,I,U,M,O=0,T=0,K=0,N=false,J=new Array(),G=new Array();if(!Q){Q=F.selection.getMonth()+1}if(!R){R=F.selection.getFullYear()}g=this.getDayMap(Q,R,u,true);if(A.scheduleAfter.selection){N=A.scheduleAfter.selection}if(A.scheduleAfter===false){N=B}L=d('<span class="back">&#9664;</span>').appendTo(j);H=new Date(R,Q-1,0);if(!F.scheduling||(F.scheduling&&H.getTime()>=N.getTime())){L.click(function(){F.scope=l;F.selection=new Date(R,Q-2);F.render(F.selection.getMonth()+1,F.selection.getFullYear());F.change()})}V=d('<span class="next">&#9654;</span>').click(function(){F.scope=l;F.selection=new Date(R,Q);F.render(F.selection.getMonth()+1,F.selection.getFullYear());F.change()}).appendTo(j);S=d("<h3></h3>").appendTo(j);for(O=0;O<i.length;O++){if(-1!=d.inArray(i[O],["m","n","M","F"])){d('<span class="month">'+n[Q]+"</span>").appendTo(S)}if(-1!=d.inArray(i[O],["y","Y"])){d('<span class="year">'+R.toString()+"</span>").appendTo(S)}d("<span> </span>").appendTo(S)}G[T]=d('<div class="week"></week>').appendTo(j);K=u;for(O=0;O<7;O++){P=v[K];J[O]=d('<div class="label">'+P.substr(0,3)+"</span>").appendTo(G[T]);K++;if(K>=v.length){K=0}}for(O=0;O<g.length;O++){var I=g[O].getMonth()+1,U=g[O].getFullYear(),M=new Date(U,I-1,g[O].getDate());if(O%7==0){G[++T]=d('<div class="week"></div>').appendTo(j)}if(g[O]!=-1){t[O]=d('<div title="'+O+'">'+M.getDate()+"</div>").appendTo(G[T]);t[O].date=M;if(I!=Q){t[O].addClass(c)}if(F.scheduling&&M.getTime()<N.getTime()){t[O].addClass(c)}if(M.getTime()==B.getTime()){t[O].addClass("today")}t[O].hover(function(){d(this).addClass(D)},function(){d(this).removeClass(D)});t[O].mousedown(function(){d(this).addClass(h)});t[O].mouseup(function(){d(this).removeClass(h)});if(!F.scheduling||(F.scheduling&&M.getTime()>=N.getTime())){t[O].click(function(){F.resetCalendar();if(!d(this).hasClass(c)){d(this).addClass(w)}F.select(g[d(this).attr("title")]);F.scope="day";if(F.selection.getMonth()+1!=Q){F.render(F.selection.getMonth()+1,F.selection.getFullYear());F.autoselect()}else{F.ui=false;j.hide()}F.change().trigger("calendarSelect")})}}}return this};F.autoselect=function(){for(var G=0;G<g.length;G++){if(g[G].getTime()==F.selection.getTime()){return t[G].addClass(w)}}};F.resetCalendar=function(){for(var G=0;G<t.length;G++){t[G].removeClass(w)}};F.getDayMap=function(N,P,S,R){var J,H,L,G,T,M,Q=1,O=0,U=new Array(),K=(N-1==0)?12:N-1,I=(K==12)?P-1:P;if(N==9&&P==1752){return k}for(J=0;J<E;J++){U.push(-1)}H=z[(F.is_leapyear(I))?1:0][K];L=z[(F.is_leapyear(P))?1:0][N];G=F.dayInWeek(1,N,P,S);T=F.dayInWeek(1,N,P,S);if(R){while(T--){U[T]=new Date(I,K-1,H--)}}while(L--){U[G++]=new Date(P,N-1,Q++)}M=U.length-G;if(R){while(O<M){U[G++]=new Date(P,N,++O)}}return U};F.dayInYear=function(H,K,J){var I,G=F.is_leapyear(J)?1:0;for(I=1;I<K;I++){H+=z[G][I]}return H};F.dayInWeek=function(I,K,J,H){var G=(J-1)*365+F.leapYearsSinceBC(J-1)+F.dayInYear(I,K,J),L=x;if(G<r){L=((G-1+e)%7)}if(G>=(r+y)){L=(((G-1+e)-y)%7)}if(L<=H){return L+=(7-H)}else{return L-=H}};F.is_leapyear=function(G){if(G<=1752){return !((G)%4)}else{return((!((G)%4)&&((G)%100)>0)||(!((G)%400)))}};F.centuriesSince1700=function(G){if(G>1700){return(Math.floor(G/100)-17)}else{return 0}};F.quadCenturiesSince1700=function(G){if(G>1600){return Math.floor((G-1600)/400)}else{return 0}};F.leapYearsSinceBC=function(G){return(Math.floor(G/4)-F.centuriesSince1700(G)+F.quadCenturiesSince1700(G))};if(p!==false){pos=p.offset();pad=0;if(pos.left+pos.top==0){pos=p.parent().parent().css("display","block").offset();pad=6}j.css({left:pos.left,top:pos.top+p.outerHeight(true)+pad});if(s!==false&&(f.val()+s.val()+a.val()!="")){F.selection=new Date(f.val(),s.val()-1,a.val())}b.focus(function(G){F.show();F.focused=d(this)}).click(function(){if(F.focused){F.focused.focus().select()}}).blur(function(G){if(F.ui){d(this).focus().select()}else{F.hide()}}).bind("change.input",function(){F.trigger("updated")}).trigger("change.input")}if(A.scheduleAfter.selection){A.scheduleAfter.change(function(){F.render().autoselect()})}if(m){F.change()}F.render().autoselect();return this};